; Test suite for MPB.  This file runs MPB for a variety of cases,
; and compares it against known results from previous versions.  If the
; answers aren't sufficiently close, it exits with an error.

;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;

; Some general setup and utility routines first:

(set! tolerance 1e-12) ; use a low tolerance to get consistent results

; function to check if two results are sufficently close:
(define (almost-equal? x y)
  (or 
   (< (abs (- x y)) (* 1e-6 (+ (abs x) (abs y))))
   (and (< (abs x) 1e-3) (< (abs (- x y)) 1e-3))))

; Convert a list l into a list of indices '(1 2 ...) of the same length.
(define (indices l)
  (if (null? l)
      '()
      (cons 1 (map (lambda (x) (+ x 1)) (indices (cdr l))))))

; Check whether the freqs returned by a run (all-freqs) match correct-freqs.
(define (check-freqs correct-freqs)
  (define (check-freqs-aux fc-list f-list ik)
    (define (check-freqs-aux2 fc f ib)
      (if (not (almost-equal? fc f))
	  (error "check-freqs: k-point " ik " band " ib " is "
		 f " instead of " fc)))
    (if (= (length fc-list) (length f-list))
	(map check-freqs-aux2 fc-list f-list (indices f-list))
	(error "check-freqs: wrong number of bands at k-point " ik)))
  (if (= (length correct-freqs) (length all-freqs))
      (begin
	(map check-freqs-aux correct-freqs all-freqs (indices all-freqs))
	(display "check-freqs: PASSED\n"))
      (error "check-freqs: wrong number of k-points")))

;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;

; First test: a simple 1d Bragg mirror:

(display-many
 "**************************************************************************\n"
 " Test case: 1d quarter-wave stack.\n"
 "**************************************************************************\n"
)

(set! geometry (list (make cylinder (material (make dielectric (epsilon 9.0)))
			   (center 0) (axis 1)
			   (radius infinity) (height 0.25))))
(set! k-points (interpolate 4 (list (vector3 0 0 0) (vector3 0.5 0 0))))
(set! grid-size (vector3 32 1 1))
(set! num-bands 8)

(define correct-freqs '((6.71526498584553e-6 0.648351062968237 0.666667518888667 1.29488075673619 1.33336075480093 1.93757672851408 2.00024045562498 2.57413377739862) (0.0567106459395599 0.599851835768395 0.715264618493032 1.25335163284172 1.37508036417516 1.90230303083039 2.03577843671071 2.54476073144309) (0.111808338549778 0.54496403537056 0.77047013248268 1.19886555431273 1.43019048406127 1.84869942534301 2.09026194963917 2.4930518553253) (0.162554443030995 0.494234387214999 0.821807214979032 1.14762423868066 1.48265526473299 1.7965649947526 2.14420182927271 2.44000721223445) (0.202728586444533 0.454051807431862 0.862903053647561 1.1065252897017 1.52568848270995 1.75360874628753 2.19029794218109 2.3942414201896) (0.219409188989471 0.437366603189745 0.880190598314617 1.08923081762878 1.5443398403343 1.7349704450792 2.21143711778794 2.3731975719957)))

(run-tm)
(check-freqs correct-freqs)

(run-te)
(check-freqs correct-freqs)

;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;

; Square lattice of dielectric rods in air.

(display-many
 "**************************************************************************\n"
 " Test case: Square lattice of dielectric rods in air.\n"
 "**************************************************************************\n"
)

(set! geometry (list
		(make cylinder (material (make dielectric (epsilon 11.56))) 
		      (center 0 0) (radius 0.2) (height infinity))))
(set! k-points (interpolate 4 (list (vector3 0) (vector3 0.5)
				    (vector3 0.5 0.5 0) (vector3 0))))
(set! grid-size (vector3 32 32 1))
(set! num-bands 8)

(run-te)
(check-freqs '((4.728854851107e-5 0.569610345457166 0.785802212067737 0.786945290721971 0.917802861214639 1.01216042014124 1.01430943054715 1.09935842633989) (0.089760513558691 0.567775702933109 0.770832700490997 0.788647583822924 0.9123503096135 1.00988836254091 1.01360165789865 1.1232097227349) (0.178798585626805 0.560421623648132 0.733004475480158 0.793172725587405 0.897639036981303 1.0173596810686 1.01801244111016 1.12486117982218) (0.266114228441602 0.540613085852257 0.689749152457676 0.798942305858755 0.882562948451381 1.02535626996242 1.03929934487726 1.11585181440822) (0.349711143879172 0.498277834488538 0.660612086561356 0.803766263089327 0.872664358590139 1.03426210883875 1.0683057178156 1.10393735417985) (0.412771274163717 0.447835194691852 0.651700365221266 0.805653288305567 0.86928614711978 1.03914786804793 1.09720939417521 1.09737640787312) (0.423695235840676 0.452300559126836 0.647371939048826 0.809835188215416 0.863762110355205 0.994662053797214 1.05882982439603 1.12027293539092) (0.454669663767838 0.464824394247223 0.635458843749843 0.821693639963614 0.839208397540604 0.942686101538598 1.01448287259195 1.12955528827976) (0.482781509262275 0.501076451791856 0.618668701536852 0.7857674789349 0.839918414164602 0.918314486908161 0.971022738311697 1.13339846764148) (0.501064899477107 0.555710844513779 0.60158550051619 0.721078054064055 0.863301968565625 0.910594300775876 0.931815874689701 1.1351816225499) (0.509846617199763 0.592581246071565 0.593316813086718 0.680292915843024 0.883905840207926 0.905822874866375 0.908791114809855 1.13571883400608) (0.477410083549302 0.55260094904297 0.606704018972245 0.745955782636517 0.853904088817416 0.906987471813781 0.951673369567842 1.13445901689539) (0.373362601623151 0.5490354805259 0.645201219927173 0.821045553069643 0.835145183500001 0.906593049041648 1.02176110668462 1.12768479649059) (0.252169664420845 0.557866043890155 0.700688907524171 0.80328531441322 0.906723053225738 0.907503652235295 1.09510180169141 1.10238225772799) (0.126794407730241 0.566265361961376 0.75823515455693 0.790694978908382 0.911317408802433 0.973111364996136 1.04878975480156 1.12656170586406) (9.93927608250512e-6 0.569610345042183 0.785802202278587 0.786945290457814 0.917802860447485 1.01216041824673 1.01430942083961 1.09935842417636)))

(run-tm)
(check-freqs '((6.58981963917309e-6 0.550430733297181 0.566241371572933 0.566241372125503 0.8351983924948 0.872522248483414 0.972318182935093 1.08920253827595) (0.0654861239931205 0.527080481386501 0.566799276723092 0.589165207583527 0.835576055420277 0.870980062510902 0.960846516271253 1.05902201007087) (0.128358448220379 0.495999172053283 0.568271183793947 0.619721421821542 0.83356296053501 0.867048180728941 0.930077475879064 1.04306779423841) (0.185088034646168 0.463940092591726 0.57011390086135 0.653567078119876 0.817881354335415 0.862372411968926 0.901875501411505 1.04123744476647) (0.229126816106051 0.43559388786256 0.571624367576723 0.691156829457416 0.782224998818748 0.858716310160016 0.891825123376884 1.04461063360315) (0.247300695978625 0.422810121338952 0.572206120755166 0.722519491334619 0.749366763350306 0.857346110872013 0.890391539630876 1.04686787134663) (0.250809748876838 0.429554276589767 0.565096567433195 0.720355410167647 0.758471422548507 0.858178250953099 0.890488360211729 1.03491655456898) (0.26025507910793 0.448078995510868 0.547933657267558 0.713707158676041 0.782090347331519 0.861016380824532 0.89074133624683 1.00608368836462) (0.272587744219053 0.473364092541664 0.528315799677668 0.70281184750316 0.814130266528788 0.866746367060004 0.8910500680573 0.969737884996935) (0.283290179911777 0.496884116924499 0.512907153632597 0.690607961804491 0.850483079371795 0.876011182318544 0.891266436104096 0.930779872946854) (0.287601798191014 0.507006838454079 0.507006838473406 0.684706840343997 0.883530037846809 0.883530037859491 0.889824048139947 0.898389144733814) (0.277734985833239 0.494789217188109 0.512794766064303 0.693585317451106 0.841827176572053 0.865559776629328 0.911829652961076 0.913648622064153) (0.241654191432774 0.481926694372205 0.527837662338828 0.687466863311822 0.83163900349694 0.850551381736133 0.915313305867981 0.946702579741239) (0.176222602974132 0.490886438975107 0.546175771972137 0.650073604192216 0.84112523185275 0.853522369318241 0.92744923558447 0.987456182883724) (0.092014400137279 0.518511998115017 0.560750416136323 0.604065528160267 0.836485467979103 0.868856191282424 0.954250999825648 1.03716877064742) (6.58977590429093e-6 0.55043073325445 0.56624137157312 0.566241372124032 0.835198392493285 0.872522248483061 0.972318182913658 1.08920253862474)))

;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;

; Using the targeted solver to find a defect state in a 5x5 triangular
; lattice of rods.

(display-many
 "**************************************************************************\n"
 " Test case: 5x5 triangular lattice of rods in air, dipole defect states.\n"
 "**************************************************************************\n"
)

(set! geometry-lattice (make lattice (size 5 5 1)
                         (basis1 (/ (sqrt 3) 2) 0.5)
                         (basis2 (/ (sqrt 3) 2) -0.5)))
(set! k-points (list (vector3 (/ -3) (/ 3) 0))) ; K
(set! geometry (list
		(make cylinder (material (make dielectric (epsilon 12))) 
		      (center 0 0) (radius 0.2) (height infinity))))
(set! geometry (geometric-objects-lattice-duplicates geometry))
(set! geometry (append geometry 
                       (list (make cylinder (center 0 0 0) 
                                   (radius 0.33) (height infinity)
                                  (material (make dielectric (epsilon 12)))))))
(set! grid-size (vector3 (* 16 5) (* 16 5) 1))
(set! num-bands 2)
(set! target-freq 0.36)
(run-tm)
(check-freqs '((0.336475392813112 0.337004057978497)))

;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;

(display-many
 "**************************************************************************\n"
 " Test case: fcc lattice of air spheres in dielectric.\n"
 "**************************************************************************\n"
)

(set! geometry-lattice (make lattice
			 (basis1 0 1 1)
			 (basis2 1 0 1)
			 (basis3 1 1 0)))
(set! k-points (interpolate 1 (list
			       (vector3 0 0.5 0.5)            ; X
			       (vector3 0 0.625 0.375)        ; U
			       (vector3 0 0.5 0)              ; L
			       (vector3 0 0 0)                ; Gamma
			       (vector3 0 0.5 0.5)            ; X
			       (vector3 0.25 0.5 0.75)        ; W
			       (vector3 0.375 0.375 0.75))))  ; K
(set! geometry (list (make sphere (center 0) (radius 0.5) (material air))))
(set! default-material (make dielectric (epsilon 11.56)))
(set! grid-size (vector3 16 16 16))
(set! mesh-size 5)
(set! num-bands 10)
(run)
(check-freqs '((0.36740266120816 0.369423419557983 0.380313489679436 0.3818216501707 0.494027883609878 0.511501075197029 0.520229780059488 0.522932480632918 0.589746021792143 0.654835118384378) (0.365497816716618 0.374846395891662 0.383087873859041 0.385343065924314 0.470674067307498 0.505277703714121 0.521921462734047 0.530870719697934 0.605858443454724 0.638232374511377) (0.354749117316649 0.378725119472235 0.390251662577336 0.399430581363773 0.437685823920157 0.493067188428436 0.525995000177792 0.541190506758158 0.633263715515043 0.633813372373362) (0.320987909849108 0.329071009556332 0.395772119559967 0.398988043350952 0.461982696666239 0.512849967722734 0.532365884858942 0.546797402152528 0.628260953602865 0.639702463113998) (0.304734378532973 0.306384394851798 0.385239546039279 0.387808575975424 0.491972006596066 0.535492408967796 0.536299419341307 0.539095240499526 0.621890754085433 0.624216956740668) (0.177788476567772 0.178678096986619 0.47190121311717 0.475341503162068 0.504265405811503 0.53516068631247 0.538175421517073 0.540417555256511 0.621112008682908 0.622686007544725) (6.13166693600701e-6 8.05511702096386e-6 0.518581770964319 0.523323616813286 0.523323618095213 0.543982772186965 0.543982772876901 0.546986800247467 0.606491040890839 0.608970040343773) (0.205113618431216 0.205886305557539 0.472124866705332 0.474834060100379 0.507589563683485 0.526412357235264 0.529117716786996 0.531758018602072 0.599247235169019 0.652754361877104) (0.367402661208136 0.369423419557954 0.380313489679422 0.381821650170703 0.494027883609782 0.51150107519685 0.520229780059476 0.522932480632863 0.589746021791715 0.654835118382045) (0.369565262202954 0.374481167102769 0.38369086050624 0.390873134430402 0.462133818158507 0.500580314645478 0.503601584636612 0.549325604661139 0.617406905049141 0.628360351989734) (0.370958459158381 0.384024089882822 0.384275113488983 0.408169159107744 0.433781488750729 0.488692363460369 0.490307718128851 0.56835744403604 0.616857025429936 0.650969493279547) (0.361712552864854 0.380486775489389 0.38729205679082 0.404018430489697 0.436900280433716 0.491985824196426 0.503492371442705 0.560332683818721 0.623835841308089 0.641035087393266) (0.356604717484288 0.377841304835848 0.388488279802544 0.400930271954659 0.436439184605941 0.493532186130499 0.528401192977172 0.540885848254659 0.63412416995121 0.634772774300151)))

;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;

(display-many
 "**************************************************************************\n"
 " Test case: simple cubic lattice with anisotropic dielectric.\n"
 "**************************************************************************\n"
)

(set! k-points (list (vector3 0) (vector3 0.5)
		     (vector3 0.5 0.5) (vector3 0.5 0.5 0.5)))
(set! grid-size (vector3 16 16 16))
(set! mesh-size 5)
(define hi-all (make dielectric (epsilon 12)))
(define hi-x (make dielectric-anisotropic (epsilon-diag 12 1 1)))
(define hi-y (make dielectric-anisotropic (epsilon-diag 1 12 1)))
(define hi-z (make dielectric-anisotropic (epsilon-diag 1 1 12)))
(set! geometry
	(list (make block (center 0) (size 0.313 0.313 1) (material hi-z))
	      (make block (center 0) (size 0.313 1 0.313) (material hi-y))
	      (make block (center 0) (size 1 0.313 0.313) (material hi-x))
	      (make block (center 0) (size 0.313 0.313 0.313) 
		    (material hi-all))))
(set! num-bands 3)
(run)

(check-freqs '((6.66222251456307e-6 6.66227566476e-6 0.546007449856072) (0.250204027316874 0.250204027316909 0.427550121407706) (0.290604311903622 0.333913084881104 0.477111252827531) (0.351288161127344 0.351288161127375 0.480258484218935)))

;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;

(display "PASSED all tests.\n")

